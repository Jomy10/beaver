name: Test macOS

on:
  push:
    branches: [master, "fix-gh-action"]

jobs:
  test:
    name: Build and test
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v3

    # Homebrew
    - name: Set up Homebrew
      id: set-up-homebrew
      uses: Homebrew/actions/setup-homebrew@master
    - name: Cache Homebrew Bundler RubyGems
      id: cache
      uses: actions/cache@v3
      with:
        path: ${{ steps.set-up-homebrew.outputs.gems-path }}
        key: ${{ runner.os }}-rubygems-${{ steps.set-up-homebrew.outputs.gems-hash }}
        restore-keys: ${{ runner.os }}-rubygems-
    - name: Install Homebrew Bundler RubyGems
      if: steps.cache.outputs.cache-hit != 'true'
      run: brew install-bundler-gems
    
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: false
    - name: Build
      run: zsh build.sh build install
    - name: check for native extension errors
      run: cat  /Users/runner/hostedtoolcache/Ruby/*/x64/lib/ruby/gems/*/extensions/*/*/msgpack-*/mkmf.log
    - name: setup minitest
      run: gem install minitest
    - name: include path
      run: |
        ln -s /Library/Developer/CommandLineTools/SDKs/MacOSX*.sdk/usr/include/ /usr/include || true
    - name: tests
      run: |
        echo $PATH
        echo $LD_LIBRARY_PATH
        echo $SDKROOT
        echo | clang -xc -E -v -
    - name: export SDK path
      run: export SDKROOT=$(xcrun --sdk macosx --show-sdk-path)
    - name: setup swift
      uses: swift-actions/setup-swift@v1
      with:
        swift-version: '5.9'
    - name: Run tests
      run: GH_ACTION=1 zsh build.sh test-workflow

